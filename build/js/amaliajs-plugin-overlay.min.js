/*!Amalia.js ========== V1.3.7, © INA 2021 */
/**
 * Copyright (c) 2015 Institut National de l'Audiovisuel, INA
 * This file is part of amalia.js

 * amalia.js is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

 * Redistributions of source code, javascript and css minified versions
 * must retain the above copyright notice, this list of conditions and the following disclaimer.

 * Neither the name of the copyright holder nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.

 * You should have received a copy of the GNU General Public License
 * along with amalia.js. If not, see <http://www.gnu.org/licenses/>

 *
 * amalia.js is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 */


$.Class("fr.ina.amalia.player.plugins.overlay.SpatialsDataParser",{},{data:null,spatials:null,settings:{},logger:null,localisationManager:null,init:function(a){this.spatials=[],this.settings=$.extend({cuepointMinDuration:0,debug:!1},a||{}),this.localisationManager=new fr.ina.amalia.player.LocalisationManager,void 0!==fr.ina.amalia.player.log&&void 0!==fr.ina.amalia.player.log.LogHandler&&(this.logger=new fr.ina.amalia.player.log.LogHandler({enabled:this.settings.debug}))},parserSpacialMetadata:function(a,t,e){this.data=a,this.spatials=[];for(var s=null,l=0;l<this.data.length;l++)(s=this.data[l]).hasOwnProperty("sublocalisations")&&null!==s.sublocalisations&&s.sublocalisations.hasOwnProperty("localisation")&&0<s.sublocalisations.localisation.length?this.createSpatialItem(s,t,e):s.hasOwnProperty("sublocalisations")&&null===s.sublocalisations&&s.hasOwnProperty("shape")&&null!==s.shape&&this.createSpatialItemPoint(s,t,e);return null!==this.logger&&(this.logger.trace(this.Class.fullName,"parserMetadata"),this.logger.info(this.data)),this.getData()},createSpatialItemPoint:function(a,t,e){var s=a,l=$.extend(!0,[],a);l.tc+=this.settings.cuepointMinDuration,this.addSpatial(s,l,a,e)},createSpatialItem:function(a,t,e){this.localisationManager.setLoc(a.sublocalisations.localisation);var s=this.localisationManager.getLocTc();if(null!==s){a.tcin=s.tcin,a.tcout=s.tcout;for(var l,i=a.sublocalisations.localisation,n=null,r=0;r<i.length;r++)n=(null===n||(l=i[r],this.addSpatial(n,l,a,t,e)),i[r])}},addSpatial:function(a,t,e,s,l){"object"==typeof a&&"object"==typeof t&&a.hasOwnProperty("tc")&&t.hasOwnProperty("tc")?this.spatials.push({start:a,end:t,type:this.getType(a),data:e.data,label:e.label,thumb:e.thumb,tcin:"string"==typeof a.tc?fr.ina.amalia.player.helpers.UtilitiesHelper.convertHourToSeconde(a.tc):a.tc,tcout:"string"==typeof t.tc?fr.ina.amalia.player.helpers.UtilitiesHelper.convertHourToSeconde(t.tc):t.tc,refLoc:e,metadataId:s,color:l}):null!==this.logger&&(this.logger.warn(this.Class.fullName+": Error to add spatial"),this.logger.warn([a,t]))},getType:function(a){return a.hasOwnProperty("shape")&&null!==a.shape&&a.shape.hasOwnProperty("t")&&"string"==typeof a.shape.t?a.shape.t.toString():"rectangle"},getData:function(){return this.spatials}}),$.Class("fr.ina.amalia.player.plugins.overlay.DrawBase",{classCss:"draw-base",eventTypes:{CLICK:"fr.ina.amalia.player.plugins.overlay.DrawBase.eventTypes.CLICK"}},{settings:{},logger:null,container:null,mediaPlayer:null,element:null,labelElement:null,data:null,paper:null,shape:null,localisationManager:null,overlayManager:null,init:function(a,t,e,s){this.mediaPlayer=t,this.data=e,this.overlayManager=s,this.localisationManager=new fr.ina.amalia.player.LocalisationManager,this.settings=$.extend({debug:!1,container:null,canvas:null,demo:!1,editable:!1,metadataId:"",style:{fill:"#00CCFF",strokeWidth:1,stroke:"#000",fillOpacity:0,strokeDasharray:"- "},labelStyle:{font:"12px Arial",opacity:1,fill:"#00CCFF",strokeWidth:1,stroke:"#000",fillOpacity:0}},a||{}),this.paper=this.settings.canvas,this.container=this.settings.container,void 0!==fr.ina.amalia.player.log&&void 0!==fr.ina.amalia.player.log.LogHandler&&(this.logger=new fr.ina.amalia.player.log.LogHandler({enabled:this.settings.debug})),"object"==typeof this.settings.canvas&&null!==this.data&&this.initialize(),null!==this.mediaPlayer&&((a=this.mediaPlayer.getContainer()).on(fr.ina.amalia.player.PlayerEventType.PLAYING,{self:this},this.onPlay),a.on(fr.ina.amalia.player.PlayerEventType.PAUSED,{self:this},this.onPause),a.on(fr.ina.amalia.player.PlayerEventType.SEEK,{self:this},this.onSeek))},initialize:function(){null!==this.logger&&(this.logger.trace(this.Class.fullName,"initialize"),this.logger.info(this.data))},getStyle:function(){return{fill:this.settings.style.fill,stroke:this.data.hasOwnProperty("color")&&""!==this.data.color&&void 0!==this.data.color?this.data.color:this.settings.style.stroke,"stroke-width":this.settings.style.strokeWidth,"fill-opacity":this.settings.style.fillOpacity,"stroke-dasharray":this.settings.style.strokeDasharray}},getLabelStyle:function(){return{font:this.settings.labelStyle.font,opacity:this.settings.labelStyle.opacity,fill:this.settings.labelStyle.fill,stroke:this.settings.labelStyle.stroke,"stroke-width":this.settings.labelStyle.strokeWidth,"fill-opacity":this.settings.labelStyle.fillOpacity}},plugFreeTransformObject:function(){null!==this.element.attrs&&(this.settings.canvas.freeTransform(this.element,{keepRatio:!1,fill:"black",draw:["bbox","circle"],range:{scale:[0,99999]}},this.onTransformationCallback).self=this)},unplugFreeTransformObject:function(){this.element.hasOwnProperty("freeTransform")&&null!==this.element.freeTransform&&this.element.freeTransform.unplug()},updatePosShape:function(a){var t,e,s=this.mediaPlayer,l=s.getCurrentTime();this.data.hasOwnProperty("refLoc")&&"object"==typeof this.data.refLoc&&this.data.refLoc.tc!==l?(!1!==this.data.refLoc.hasOwnProperty("sublocalisations")&&null!==this.data.refLoc.sublocalisations&&"object"==typeof this.data.refLoc.sublocalisations||(this.data.refLoc.sublocalisations={localisation:[]},e=parseFloat(this.data.refLoc.tc),t=jQuery.extend({},{tc:e,shape:this.data.refLoc.shape,tclevel:1}),this.data.refLoc.sublocalisations.localisation.push(t),this.data.refLoc.shape=null,e<l?(this.data.refLoc.tcin=e,this.data.refLoc.tc=e,this.data.refLoc.tcout=l):(this.data.refLoc.tcin=l,this.data.refLoc.tc=l,this.data.refLoc.tcout=e)),0<(e=$.grep(this.data.refLoc.sublocalisations.localisation,function(a){return a.tc===l})).length?e[0].shape=a:this.data.refLoc.sublocalisations.localisation.push({tc:l,shape:a,tclevel:1}),s.getContainer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:this.data.hasOwnProperty("metadataId")?this.data.metadataId:s.getSelectedMetadataId()})):this.data.hasOwnProperty("refLoc")&&"object"==typeof this.data.refLoc&&(this.data.refLoc.shape=a,s.getContainer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:this.data.hasOwnProperty("metadataId")?this.data.metadataId:s.getSelectedMetadataId()}))},onClick:function(a){null!==a.data.self.container&&a.data.self.container.trigger(fr.ina.amalia.player.plugins.overlay.DrawBase.eventTypes.CLICK,{tcin:a.data.tcin,tcout:a.data.tcout,data:a.data.data})},onPlay:function(a){null!==a.data.self.element&&(!0===a.data.self.settings.editable&&a.data.self.unplugFreeTransformObject(),a.data.self.element.resume(),null!==a.data.self.labelElement&&a.data.self.labelElement.resume())},onPause:function(a){null!==a.data.self.element&&(a.data.self.element.pause(),null!==a.data.self.labelElement&&a.data.self.labelElement.pause(),!0===a.data.self.settings.editable&&(a.data.self.unplugFreeTransformObject(),a.data.self.plugFreeTransformObject()))},onSeek:function(a){!0===a.data.self.settings.editable&&a.data.self.unplugFreeTransformObject(),a.data.self.element.remove(),null!==a.data.self.labelElement&&a.data.self.labelElement.remove()},onEndOfAnimation:function(){this.data.hasOwnProperty("self")&&!0===this.data.self.settings.editable&&this.data("self").unplugFreeTransformObject(),!0!==this.data("demo")&&this.remove()},onTransformationCallback:function(a,t){if(-1===$.inArray("init",t)&&!0===a.self.overlayManager.getEraseState()){if(a.self.data.refLoc.hasOwnProperty("sublocalisations")&&null!==a.self.data.refLoc.sublocalisations&&a.self.data.refLoc.sublocalisations.hasOwnProperty("localisation")&&null!==a.self.data.refLoc.sublocalisations.localisation)for(var e=a.self.data.refLoc.sublocalisations.localisation,s=0;s<e.length;s++)e[s].tc===a.self.data.tcout&&e.splice(s,1);else a.self.data.refLoc.delete=!0,a.self.data.refLoc.tc=null,a.self.data.refLoc.tcin=null;a.unplug(),a.subject.remove(),a.self.localisationManager.updateLocBlock(a.self.mediaPlayer.getMetadataById(a.self.data.metadataId)),a.self.mediaPlayer.getContainer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:a.self.data.hasOwnProperty("metadataId")?a.self.data.metadataId:a.self.mediaPlayer.getSelectedMetadataId()}),a.self.overlayManager.setEraseState(!1)}else(-1<$.inArray("drag end",t)||-1<$.inArray("scale end",t))&&(t={c:{x:parseFloat((a.attrs.center.x+a.attrs.translate.x)/a.self.paper.width),y:parseFloat((a.attrs.center.y+a.attrs.translate.y)/a.self.paper.height)},rx:parseFloat(a.attrs.size.x*a.attrs.scale.x/2/a.self.paper.width),ry:parseFloat(a.attrs.size.y*a.attrs.scale.y/2/a.self.paper.height),o:parseFloat(a.attrs.rotate),t:a.self.shape},a.self.updatePosShape(t))}}),fr.ina.amalia.player.plugins.overlay.DrawBase.extend("fr.ina.amalia.player.plugins.overlay.DrawRect",{classCss:"spatial-base"},{initialize:function(){if(this.shape="rectangle",this.data.hasOwnProperty("tcin")&&this.data.hasOwnProperty("tcout")&&this.data.hasOwnProperty("start")&&this.data.hasOwnProperty("end")){var a=this.getStyle(),t=this.getRectData(this.data.start),e=this.getRectData(this.data.end),s=parseFloat(this.data.tcout-this.mediaPlayer.getCurrentTime()),l=this.data.hasOwnProperty("label")?this.data.label:"";if(null!==t&&null!==e){this.element=this.settings.canvas.rect(t.x,t.y,t.w,t.h),this.element.attr(a),this.element.transform("r"+Math.round(t.o/Math.PI*180)),this.element.attr({cursor:"pointer"}),this.element.data("demo",this.settings.demo),this.element.data("self",this),!0===this.settings.labels&&""!==l&&(this.labelElement=this.settings.canvas.text(t.x,t.y,l).attr(this.getLabelStyle()));l={x:e.x,y:e.y,width:e.w,height:e.h,transform:"r"+Math.round(e.o/Math.PI*180)};return this.element.stop().animate(l,1e3*s,"",this.onEndOfAnimation),null!==this.labelElement&&(e={x:e.x,y:e.y},this.labelElement.stop().animate(e,1e3*s,"",this.onEndOfAnimation)),this.mediaPlayer.isPaused()&&(this.element.pause(),null!==this.labelElement&&this.labelElement.pause()),!0===this.settings.editable&&this.mediaPlayer.isPaused()&&this.plugFreeTransformObject(),$(this.element.node).on("click",{self:this,data:this.data,tcin:this.data.tcin,tcout:this.data.tcout},this.onClick),!0}}null!==this.logger&&(this.logger.error("Error :"+this.Class.fullName+":initialize"),this.logger.error(this.data))},getRectData:function(t){var a={x:0,y:0,w:0,h:0,r:0,o:0};try{var e=this.settings.canvas.width,s=this.settings.canvas.height;if(t.hasOwnProperty("shape"))return a.w=t.shape.rx*e*2,a.h=t.shape.ry*s*2,a.x=t.shape.c.x*e-a.w/2,a.y=t.shape.c.y*s-a.h/2,a.o=t.shape.o,a}catch(a){null!==this.logger&&(this.logger.error("Error to parse data GetRectData "),this.logger.error(t))}return null}}),fr.ina.amalia.player.plugins.overlay.DrawBase.extend("fr.ina.amalia.player.plugins.overlay.DrawEllipse",{classCss:"spatial-ellipse"},{initialize:function(){if(this.shape="ellipse",this.data.hasOwnProperty("tcin")&&this.data.hasOwnProperty("tcout")&&this.data.hasOwnProperty("start")&&this.data.hasOwnProperty("end")){var a=this.getStyle(),t=this.getEllipseData(this.data.start),e=this.getEllipseData(this.data.end),s=parseFloat(this.data.tcout-this.mediaPlayer.getCurrentTime()),l=this.data.hasOwnProperty("label")?this.data.label:"";if(null!==t&&null!==e){this.element=this.settings.canvas.ellipse(t.cx,t.cy,t.rx,t.ry),this.element.attr(a),this.element.transform("r"+Math.round(t.o/Math.PI*180)),this.element.attr({cursor:"pointer"}),!0===this.settings.labels&&""!==l&&(this.labelElement=this.settings.canvas.text(t.cx,t.cy,l).attr(this.getLabelStyle()));l={cx:e.cx,cy:e.cy,rx:e.rx,ry:e.ry,transform:"r"+Math.round(e.o/Math.PI*180)};return this.element.stop().animate(l,1e3*s,"",this.onEndOfAnimation),null!==this.labelElement&&(e={x:e.cx,y:e.cy},this.labelElement.stop().animate(e,1e3*s,"",this.onEndOfAnimation)),this.mediaPlayer.isPaused()&&this.element.pause(),$(this.element.node).on("click",{self:this,data:this.data,tcin:this.data.tcin,tcout:this.data.tcout},this.onClick),!0}}null!==this.logger&&(this.logger.error("Error :"+this.Class.fullName+":initialize"),this.logger.error(this.data))},getEllipseData:function(t){var a={x:0,y:0,rx:0,ry:0,o:0};try{var e=this.settings.canvas.width,s=this.settings.canvas.height;if(t.hasOwnProperty("shape"))return a.cx=t.shape.c.x*e,a.cy=t.shape.c.y*s,a.rx=t.shape.rx*e,a.ry=t.shape.ry*s,a.o=t.shape.o,a}catch(a){null!==this.logger&&(this.logger.error("Error to parse data getEllipseData"),this.logger.error(t))}return null}}),fr.ina.amalia.player.plugins.PluginBaseMultiBlocks.extend("fr.ina.amalia.player.plugins.OverlayPlugin",{classCss:"ajs-plugin plugin-overlay",eventTypes:{CLICK:"fr.ina.amalia.player.plugins.OverlayPlugin.eventTypes.CLICK"}},{spatialsDataParser:null,spatialsData:null,seekSpatialsData:null,container:null,canvas:null,selectedMetadataId:"",metadataManager:null,eraseState:!1,selectedShape:null,doDraw:!1,drawing:!1,drawingHandler:null,localisationManager:null,initialize:function(){this.listOfMetadataTypes=[],this.notManagedMetadataIds=[],this.managedMetadataIds=[],this.doDraw=!1,this.drawing=!1,this.settings=$.extend({offsetTime:.5,metadataId:"",editable:!1,defaultSelectedShape:"rectangle",lineDisplayMode:fr.ina.amalia.player.plugins.PluginBaseMultiBlocks.METADATA_DISPLAY_TYPE.STATIC,callbacks:{}},this.settings.parameters||{}),this.container=$("<div>",{class:this.Class.classCss}),this.pluginContainer.append(this.container),this.setSelectedShape(this.settings.defaultSelectedShape),this.canvas=null,this.spatialsData=null,this.spatialsDataParser=new fr.ina.amalia.player.plugins.overlay.SpatialsDataParser(this.settings),this.localisationManager=new fr.ina.amalia.player.LocalisationManager,this.definePlayerListeners()},initializeOnLoadStart:function(){this.updateBlockData(),this.pluginContainer.append(this.container),this.createCanvas(),this.createContextMenuOption(),this.metadataManager=this.mediaPlayer.getMetadataManager(),!0===this.settings.editable&&(this.createToolBoxCtrl(),this.createErrorContainer(),this.createDoDrawRect(),this.container.on("mousedown",{self:this},this.onMouseDown),this.container.on("mouseup",{self:this},this.onMouseUp),this.container.on("mousemove",{self:this},this.onMouseMove))},definePlayerListeners:function(){var a=this.mediaPlayer.getContainer();a.one(fr.ina.amalia.player.PlayerEventType.PLUGIN_READY,{self:this},this.onFirstTimechange),a.on(fr.ina.amalia.player.PlayerEventType.ENDED,{self:this},this.onEnd),a.on(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,{self:this},this.onTimeupdate),a.on(fr.ina.amalia.player.PlayerEventType.SEEK,{self:this},this.onSeek),$(window).on("debouncedresize",{self:this},this.onWindowResize),a.on(fr.ina.amalia.player.PlayerEventType.SELECTED_METADATA_CHANGE,{self:this},this.onSelectedMetadataChange),a.on(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{self:this},this.onDataChange),a.on(fr.ina.amalia.player.PlayerEventType.BIND_METADATA,{self:this},this.onBindMetadata),a.on(fr.ina.amalia.player.PlayerEventType.UNBIND_METADATA,{self:this},this.onUnBindMetadata),null!==this.logger&&this.logger.trace(this.Class.fullName,"definePlayerListeners")},createContextMenuOption:function(){var a=this.mediaPlayer.addMenuItemWithLink(fr.ina.amalia.player.PlayerMessage.PLUGIN_OVERLAY_CONTEXT_MENU_ENABLED_DISABLED_PLUGIN,"#","presentation");"object"==typeof a&&$(a).on("click",{self:this},function(a){a.preventDefault(),a.data.self.changeDisplayState()})},isValidMetadataType:function(){var a=this.getMetadataType();return a===fr.ina.amalia.player.PluginBindingManager.dataTypes.VISUAL_TRACKING||a===fr.ina.amalia.player.PluginBindingManager.dataTypes.VISUAL_DETECTION},changeDisplayState:function(){this.container.is(":visible")?this.container.hide():this.container.show()},updateBlockData:function(){if(""!==this.settings.metadataId)this.spatialsData=this.updateMetadata(this.settings.metadataId,0,this.mediaPlayer.getDuration());else{var a=this.getBindIds();this.spatialsData=[];for(var t=0;t<a.length;t++){var e=this.mediaPlayer.getBlockMetadata(a[t]),s="";null!==e&&e.hasOwnProperty("viewControl")&&null!==e.viewControl&&(s=e.viewControl.hasOwnProperty("color")?e.viewControl.color:"");s=this.updateMetadata(a[t],0,this.mediaPlayer.getDuration(),s);this.spatialsData=this.spatialsData.concat(s)}}},updateMetadata:function(a,t,e,s){e=this.mediaPlayer.getMetadataWithRange(a,t,e);return this.spatialsDataParser.parserSpacialMetadata(e,a,s)},updatePos:function(a){var t;void 0!==this.spatialsData&&null!==this.spatialsData&&"object"==typeof this.spatialsData&&0<this.spatialsData.length&&(a=parseFloat(a),0<(a=(t=this.mediaPlayer.isPaused())?this.getSeekDisplayItems(a):this.getDisplayItems(a)).length&&this.createObject(a,t))},getDisplayItems:function(a){for(var t=null,e=[],s=0;s<this.spatialsData.length;s++)"object"==typeof(t=this.spatialsData[s])&&t.hasOwnProperty("tcin")&&a>=parseFloat(t.tcin)&&a<=parseFloat(t.tcin)+this.settings.offsetTime&&(e.push(t),this.spatialsData.splice(s,1));return e},createCanvas:function(){var a=this.getVideoSize(),t=a.w,a=a.h;this.canvas=new Raphael(this.container.get(0),t,a),this.canvas.canvas.className.baseVal="overlay-canvas",this.updateCanvasPosition(),this.container.on(fr.ina.amalia.player.plugins.overlay.DrawBase.eventTypes.CLICK,{self:this},this.onClickAtObject),null!==this.logger&&this.logger.trace(this.Class.fullName,"CreateCanvas width:"+t+" height: "+a)},getVideoSize:function(){var a=this.mediaPlayer.getMediaPlayer(),t=a.get(0).videoHeight,e=a.get(0).videoWidth,s=a.width()/e,a=a.height()/t,a=Math.min(s,a);return{w:a*e,h:a*t}},updateCanvasPosition:function(){var a=this.getVideoSize(),t=this.mediaPlayer.getMediaPlayer();this.container.find(".overlay-canvas").css({left:(t.width()-a.w)/2,top:(t.height()-a.h)/2})},createObject:function(a){if(null!=a){var t=$.extend({canvas:this.canvas,container:this.container,debug:this.settings.debug,color:""},this.settings||{}),e=null;if("object"==typeof a&&0<a.length)for(var s=0;s<a.length;++s)switch(e=a[s],t.editable=!0===this.settings.editable&&e.metadataId===this.getSelectedMetadataId(),e.hasOwnProperty("type")?e.type:""){case"rectangle":new fr.ina.amalia.player.plugins.overlay.DrawRect(t,this.mediaPlayer,a[s],this);break;case"ellipse":new fr.ina.amalia.player.plugins.overlay.DrawEllipse(t,this.mediaPlayer,a[s],this);break;default:null!==this.logger&&this.logger.warn(this.Class.fullName+": L'objet ne peut pas être interpreté.")}}else this.logger.error("Error to create object"),this.logger.error(a);return null},clearCanvas:function(){this.canvas.remove(),this.createCanvas(),this.spatialsData=this.spatialsDataParser.getData(),this.createDoDrawRect(),null!==this.logger&&this.logger.trace(this.Class.fullName,"clearCanvas : "+this.spatialsData.length)},createToolBoxCtrl:function(){var a=$("<div>",{class:"toolbox"}).draggable({containment:"parent",scroll:!1});a.css("position","absolute"),a.append(this.createAddToolboxItem()),a.append(this.createEraserToolboxItem()),a.append(this.createNavCtrlToolboxItem()),a.find(".add-shapebox .add div.add-ctrl span.ctrl").on("click",{self:this},function(a){a.data.self.openAddShape()}),a.find(".add-shapebox .add div.add-selectFormBox div.close-box span.ctrl").on("click",{self:this},function(a){a.data.self.closeAddShape()}),a.find(".erase-box span.ctrl").on("click",{self:this},this.onClickToEraser),this.container.append(a)},createAddToolboxItem:function(){var a=$("<div>",{class:"add-shapebox"}),t=$("<div>",{class:"add"}),e=$("<div>",{class:"add-ctrl"}),s=$("<span>",{class:"ctrl ajs-icon ajs-icon-plus"});e.append(s),t.append(e);var l=$("<div>",{class:"add-selectFormBox"}).hide(),s=$("<div>",{class:"close-box"}),e=$("<span>",{class:"ctrl ajs-icon ajs-icon-remove"});s.append(e),l.append(s);e=$("<div>",{class:"add-shape-msg",text:"Sélectionnez une forme"});l.append(e);s=$("<div>",{class:"add-shape-rectangle"}),e=$("<span>",{class:"ajs-icon ajs-icon-stop"}).on("click",{self:this},function(a){a.data.self.setSelectedShape("rectangle")});return s.append(e),l.append(s),t.append(l),a.append(t),a},createEraserToolboxItem:function(){var a=$("<div>",{class:"erase-box"}),t=$("<span>",{class:"ctrl ajs-icon ajs-icon-eraser"});return a.append(t),a},createNavCtrlToolboxItem:function(){var a=$("<div>",{class:"nav-box"}),t=$("<div>",{class:"nav-left-box"}),e=$("<span>",{class:"ctrl ajs-icon ajs-icon-chevron-left"});t.append(e),a.append(t);e=$("<div>",{class:"nav-right-box"}),t=$("<span>",{class:"ctrl ajs-icon ajs-icon-chevron-right"});return e.append(t),a.append(e).hide(),a},createErrorContainer:function(){var a=$("<div>",{class:"error"}).hide();this.container.append(a)},setErrorMsg:function(a){a=$("<span>",{class:"msg",text:a});this.container.find(".error").empty().append(a).show()},clearErrorMsg:function(){this.container.find(".error").empty().hide()},openAddShape:function(){var a;this.startDraw()&&((a=this.container.find(".toolbox")).find(".add .add-ctrl").hide(),a.find(".add .add-selectFormBox").show(),a.find(".add-selectFormBox div").removeClass("on"),a.find(".add-selectFormBox div.add-shape-"+this.selectedShape).addClass("on"),a.find(".erase-box").hide())},closeAddShape:function(){var a=this.container.find(".toolbox");a.find(".add .add-selectFormBox").hide(),a.find(".add div.add-ctrl").show(),a.find(".erase-box").show(),this.endDraw()},getEraseState:function(){return this.eraseState},setEraseState:function(a){this.eraseState=a,this.settings.eraseState=a,this.container.toggleClass("eraser",a),this.container.find(".toolbox").find(".erase-box").toggleClass("on",a)},setSelectedShape:function(a){-1<$.inArray(a,this.listOfShapes)?this.selectedShape=a:this.selectedShape=this.settings.defaultSelectedShape;a=this.container.find(".toolbox");a.find(".add-selectFormBox div").removeClass("on"),a.find(".add-selectFormBox div.add-shape-"+this.selectedShape).addClass("on")},getSelectedShape:function(){return this.selectedShape},startDraw:function(){if(null!==this.getSelectedMetadataId()){if(this.isValidMetadataType())return this.doDraw=!0,this.container.addClass("draw"),this.setEraseState(!1),this.mediaPlayer.pause(),!0;this.setErrorMsg(fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_ITEMS_EDITOR_NEED_METADTA_ITEM_TYPE)}else this.setErrorMsg(fr.ina.amalia.player.PlayerMessage.PLUGIN_METADATA_ITEMS_EDITOR_NEED_METADTA);return!1},getMetadataType:function(){var a=this.metadataManager.getBlockMetadata(this.getSelectedMetadataId());return null!==a&&""!==a.type?a.type:null},getSelectedMetadataId:function(){return this.selectedMetadataId},setSelectedMetadataId:function(a){"string"==typeof a?(this.selectedMetadataId=a,this.clearErrorMsg()):this.selectedMetadataId=null},endDraw:function(){this.doDraw=!1,this.container.removeClass("draw"),this.container.find(".toolbox .add-ctrl").removeClass("on"),this.setEraseState(!1)},createDoDrawRect:function(){this.drawingHandler=this.canvas.rect(0,0,10,10),this.drawingHandler.fig="DoDrawRect",this.drawingHandler.attr({stroke:"#3cf"}),this.drawingHandler.toFront(),this.drawingHandler.hide(),this.drawingHandler.doDraw={}},drawShape:function(a,t,e,s,l){var i=null;if("ellipse"===a?(i=this.canvas.ellipse(t,e,s,l)).fig="ellipse":(i=this.canvas.rect(t,e,s,l)).fig="rectangle",i){i.objectId="spatial_"+fr.ina.amalia.player.helpers.UtilitiesHelper.generateUUID(),i.attr({stroke:"#3cf"}),i.translate=[0,0],i.scale=[1,1],i.rotate=0;return(i.data.self=this).canvas.freeTransform(i,{keepRatio:!1,fill:"black",draw:["bbox","circle"],range:{scale:[0,99999]}},this.onTransformationCallback).self=this,i}return null},createDataShape:function(a,t){var e=this.mediaPlayer,t={shape:t,sublocalisations:null,tclevel:0,thumb:null,type:null,tc:e.getCurrentTime(),tcin:e.getCurrentTime(),label:a.hasOwnProperty("objectId")?a.objectId:""};return(a.data=t).refLoc=e.addMetadataItem(this.getSelectedMetadataId(),t),t},refreshSeekData:function(){if(""!==this.settings.metadataId)this.seekSpatialsData=this.updateMetadata(this.settings.metadataId,0,this.mediaPlayer.getDuration());else{var a=this.getBindIds();this.seekSpatialsData=[];for(var t=0;t<a.length;t++){var e=this.updateMetadata(a[t],0,this.mediaPlayer.getDuration());this.seekSpatialsData=this.seekSpatialsData.concat(e)}}},getSeekDisplayItems:function(a){var t=null,e=[];if(null!==this.seekSpatialsData)for(var s,l=0;l<this.seekSpatialsData.length;l++)"object"==typeof(t=this.seekSpatialsData[l])&&t.hasOwnProperty("tcin")&&t.hasOwnProperty("tcout")&&a>=parseFloat(t.tcin)&&a<=parseFloat(t.tcout)&&(t.start=jQuery.extend(!0,{},this.seekSpatialsData[l].start),s=this.spatialInterpolation(t.start,t.end,this.mediaPlayer.getCurrentTime()),t.start.shape.c.x=s.x,t.start.shape.c.y=s.y,t.start.shape.rx=s.rx,t.start.shape.ry=s.ry,e.push(t),this.seekSpatialsData.splice(l,1));return e},linearInterpolation:function(a,t,e,s,l){return a+(t-a)/(s-e)*(l-e)},spatialInterpolation:function(a,t,e){return{x:this.linearInterpolation(a.shape.c.x,t.shape.c.x,a.tc,t.tc,e),y:this.linearInterpolation(a.shape.c.y,t.shape.c.y,a.tc,t.tc,e),rx:this.linearInterpolation(a.shape.rx,t.shape.rx,a.tc,t.tc,e),ry:this.linearInterpolation(a.shape.ry,t.shape.ry,a.tc,t.tc,e)}},onWindowResize:function(a){var t=a.data.self.getVideoSize(),e=t.w,t=t.h;null!==this.canvas&&(a.data.self.clearCanvas(),a.data.self.canvas.setSize(e,t),a.data.self.updateCanvasPosition()),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onWindowResize W: "+e+" H:"+t)},onFirstTimechange:function(a){a.data.self.initializeOnLoadStart(),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"timechange")},onEnd:function(a){a.data.self.clearCanvas()},onTimeupdate:function(a,t){a.data.self.updatePos(parseFloat(t.currentTime))},onSeek:function(a){a.data.self.clearCanvas(),a.data.self.updateBlockData(),a.data.self.refreshSeekData()},onClickAtObject:function(event,data){if(void 0!==event.data.self.settings.parameters)try{eval(event.data.self.settings.parameters.callbacks.click+"(data)")}catch(e){null!==event.data.self.logger&&event.data.self.logger.warn("Send callback failed.")}null!==event.data.self.logger&&(event.data.self.logger.info(event.data.self.Class.fullName,"onClickAtObject"),event.data.self.logger.warn(event.data),event.data.self.logger.warn(data))},onSelectedMetadataChange:function(a,t){null!==t.metadataId&&a.data.self.setSelectedMetadataId(t.metadataId),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onSelectedMetadataChange id:"+t.metadataId)},onDataChange:function(a,t){!1===a.data.self.loadDataStarted?a.data.self.isManagedMetadataId(t.id)?a.data.self.isBoundMetadataId(t.id)&&a.data.self.updateBlockData():a.data.self.bindMetadataId(t.id):null!==a.data.self.dataToDeal&&1<a.data.self.settings.lineDisplayMode&&a.data.self.dataToDeal.push(t.id)},onBeginDataChange:function(a){a.data.self.loadDataStarted=!0;for(var t=0;t<a.data.self.dataToDeal.length;t++)a.data.self.bindMetadataId(a.data.self.dataToDeal[t]);a.data.self.dataToDeal=[],a.data.self.updateBlockData(),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onBeginDataChange")},onEndDataChange:function(a){a.data.self.loadDataStarted=!1,a.data.self.updateBlockData(),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onEndDataChange")},onBindMetadata:function(a,t){a.data.self.bindMetadataId(t.id),a.data.self.updateBlockData(),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onBindMetadata Id:"+t.id)},onUnBindMetadata:function(a,t){a.data.self.unbindMetadataId(t.id),a.data.self.updateBlockData(),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onUnBindMetadata Id: "+t.id)},onMouseDown:function(a){var t,e;(!0===a.data.self.doDraw&&!0===a.ctrlKey&&!1===a.data.self.drawing||!0===a.shiftKey&&!0===a.ctrlKey)&&(e=a.data.self.getVideoSize(),t=Math.max(0,a.offsetX-(a.data.self.container.height()-45-e.h)/2),e=Math.max(0,a.offsetY-(a.data.self.container.height()-e.h)/2),a.data.self.drawing=!0,a.data.self.drawingHandler.show(),a.data.self.drawingHandler.toFront(),a.data.self.drawingHandler.doDraw.startX=t,a.data.self.drawingHandler.doDraw.startY=e+20,a.data.self.drawingHandler.attr("x",a.data.self.drawingHandler.doDraw.startX),a.data.self.drawingHandler.attr("y",a.data.self.drawingHandler.doDraw.startY))},onMouseUp:function(a){var t,e,s;!0===a.data.self.drawing&&(a.data.self.drawing=!1,a.data.self.drawingHandler.hide(),t=Math.max(0,a.data.self.drawingHandler.doDraw.endX-a.data.self.drawingHandler.doDraw.startX),s=Math.max(0,a.data.self.drawingHandler.doDraw.endY-a.data.self.drawingHandler.doDraw.startY),null!==(e=a.data.self.drawShape("rectangle",a.data.self.drawingHandler.doDraw.startX,a.data.self.drawingHandler.doDraw.startY,t,s))&&(s={c:{x:parseFloat((a.data.self.drawingHandler.doDraw.startX+a.data.self.drawingHandler.doDraw.endX)/2/a.data.self.canvas.width),y:parseFloat((a.data.self.drawingHandler.doDraw.startY+a.data.self.drawingHandler.doDraw.endY)/2/a.data.self.canvas.height)},rx:parseFloat(t/a.data.self.canvas.width/2),ry:parseFloat(s/a.data.self.canvas.height/2),o:0,t:a.data.self.getSelectedShape()},a.data.self.createDataShape(e,s)))},onMouseMove:function(a){var t,e,s,l;!0===a.data.self.drawing&&(l=a.data.self.getVideoSize(),t=Math.max(0,a.offsetX-(a.data.self.container.height()-45-l.h)/2),e=Math.max(0,a.offsetY-(a.data.self.container.height()-l.h)/2),s=Math.max(0,t-a.data.self.drawingHandler.doDraw.startX),l=Math.max(0,e-a.data.self.drawingHandler.doDraw.startY),a.data.self.drawingHandler.doDraw.endX=t,a.data.self.drawingHandler.doDraw.endY=e,a.data.self.drawingHandler.attr("width",s),a.data.self.drawingHandler.attr("height",l))},onTransformationCallback:function(a,t){!0===a.self.getEraseState()?(a.subject.data.delete=!0,a.self.localisationManager.updateSpacialLocBlock(a.self.mediaPlayer.getMetadataById(a.self.getSelectedMetadataId())),a.unplug(),a.subject.remove(),a.self.setEraseState(!1),a.self.mediaPlayer.getContainer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:a.self.getSelectedMetadataId()})):(-1<$.inArray("drag end",t)||-1<$.inArray("scale end",t))&&(t={c:{x:parseFloat((a.attrs.center.x+a.attrs.translate.x)/a.self.canvas.width),y:parseFloat((a.attrs.center.y+a.attrs.translate.y)/a.self.canvas.height)},rx:parseFloat(a.attrs.size.x*a.attrs.scale.x/2/a.self.canvas.width),ry:parseFloat(a.attrs.size.y*a.attrs.scale.y/2/a.self.canvas.height),o:parseFloat(a.attrs.rotate),t:a.self.shape},a.self.updatePosShape(t,a.subject.data))},onClickToEraser:function(a){!0===a.data.self.getEraseState()?a.data.self.setEraseState(!1):a.data.self.setEraseState(!0)},updatePosShape:function(a,t){var e,s,l=this.mediaPlayer,i=l.getCurrentTime();t.hasOwnProperty("refLoc")&&"object"==typeof t.refLoc&&t.refLoc.tc!==i?(!1!==t.refLoc.hasOwnProperty("sublocalisations")&&null!==t.refLoc.sublocalisations&&"object"==typeof t.refLoc.sublocalisations||(t.refLoc.sublocalisations={localisation:[]},s=parseFloat(t.refLoc.tc),e=jQuery.extend({},{tc:s,shape:t.refLoc.shape,tclevel:1}),t.refLoc.sublocalisations.localisation.push(e),t.refLoc.shape=null,s<i?(t.refLoc.tcin=s,t.refLoc.tc=s,t.refLoc.tcout=i):(t.refLoc.tcin=i,t.refLoc.tc=i,t.refLoc.tcout=s)),0<(s=$.grep(t.refLoc.sublocalisations.localisation,function(a){return a.tc===i})).length?s[0].shape=a:t.refLoc.sublocalisations.localisation.push({tc:i,shape:a,tclevel:1}),l.getContainer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:t.hasOwnProperty("metadataId")?t.metadataId:l.getSelectedMetadataId()})):t.hasOwnProperty("refLoc")&&"object"==typeof t.refLoc&&(t.refLoc.shape=a,l.getMediaPlayer().trigger(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{id:t.hasOwnProperty("metadataId")?t.metadataId:l.getSelectedMetadataId()}))}});