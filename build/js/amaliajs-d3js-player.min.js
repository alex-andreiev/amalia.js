/*!Amalia.js ========== V1.3.5, Â© INA 2021 */
/**
 * Copyright (c) 2015 Institut National de l'Audiovisuel, INA
 * This file is part of amalia.js

 * amalia.js is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

 * Redistributions of source code, javascript and css minified versions
 * must retain the above copyright notice, this list of conditions and the following disclaimer.

 * Neither the name of the copyright holder nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.

 * You should have received a copy of the GNU General Public License
 * along with amalia.js. If not, see <http://www.gnu.org/licenses/>

 *
 * amalia.js is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 */


fr.ina.amalia.player.plugins.PluginBaseMultiBlocks.extend("fr.ina.amalia.player.plugins.D3JsChartPlugin",{classCss:"ajs-plugin plugin-db3-js-chart",COMPONENT_NAME:"focus-component",eventTypes:{}},{container:null,loadDataStarted:!1,dataToDeal:null,selectedItem:null,chart:null,tcin:0,tcout:0,initialize:function(){this.loadDataStarted=!0,this.selectedItem=null,this.dataToDeal=[],this.chart=null,this.tcin=0,this.tcout=0,this._super(),this.settings=$.extend({defaultColor:"#00CCCC",rightClickAction:null,framerate:"25",timeFormat:"f",timecursor:!0,colors:["#0d8bc7","#00CC99","#AE4CFF","#00FFDA","#FF654C","#18B8FF","#FF38A0","#A9FF78","#FF9500","#00C7FF","#FF1986","#D7FF19","#FFD907","#4CFFEE","#FF00AD","#82FF4C"],withFocus:!1,callbacks:[{label:"voir",callback:""}]},this.settings.parameters||{}),this.container=$("<div>",{class:this.Class.classCss}),this.pluginContainer.append(this.container),this.registerMetadataType(),this.definePlayerListeners(),this.loaderContainer.show()},registerMetadataType:function(){this.listOfMetadataTypes=[],this.addManagedMetadataType(fr.ina.amalia.player.PluginBindingManager.dataTypes.HISTOGRAM)},definePlayerListeners:function(){var t=this.mediaPlayer.getContainer();t.one(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,$.proxy(this.onPluginReady,this)),t.on(fr.ina.amalia.player.PlayerEventType.BEGIN_DATA_CHANGE,$.proxy(this.onBeginDataChange,this)),t.on(fr.ina.amalia.player.PlayerEventType.END_DATA_CHANGE,$.proxy(this.onEndDataChange,this)),t.on(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,$.proxy(this.onDataChange,this)),!0===this.settings.timecursor&&t.on(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,$.proxy(this.onTimeupdate,this)),null!==this.logger&&this.logger.trace(this.Class.fullName,"DefinePlayerListeners")},initializeOnLoadStart:function(){this.tcin=this.mediaPlayer.getTcOffset(),this.tcout=this.tcin+this.mediaPlayer.getDuration(),this.createPluginContainer(),this.loaderContainer.hide(),this.createChart(),this.defineEventListeners()},defineEventListeners:function(){var t=this.mediaPlayer.getContainer();!0===this.settings.withFocus&&(this.container.find(".focus-container ."+this.Class.COMPONENT_NAME).resizable({handles:"w,e",containment:"parent",create:function(t){$(t.target).find("div.ui-resizable-handle").addClass("ajs-icon ajs-icon-reorder")},stop:$.proxy(this.onResizeStop,this)}),this.container.find(".focus-container ."+this.Class.COMPONENT_NAME).draggable({axis:"x",containment:"parent",stop:$.proxy(this.onDragStop,this)})),""===this.settings.metadataId&&t.on(fr.ina.amalia.player.PlayerEventType.SELECTED_METADATA_CHANGE,$.proxy(this.onSelectedMetadataChange,this))},createPluginContainer:function(){var t=$("<div>",{class:"components ajs-margin-top"}),a=this.createComponent(this.settings.title);t.append(a),this.container.append(t)},createComponent:function(t){var a=$("<div>",{class:"component"}),e=$("<div>",{class:"timeline-cursor"}),i=$("<p>",{class:"title"});i.html(t);var n=$("<div>",{class:"module-chart"});n.append("<svg><svg/>");t=$("<div>",{class:"line"});return a.append(e),a.append(i),a.append(n),a.append(t),!0===this.settings.withFocus&&(n=$("<div>",{class:"focus-container"}),t=$("<div>",{class:this.Class.COMPONENT_NAME}),n.append(t),a.append(n)),a},createChart:function(){var a=this;nv.addGraph({generate:function(){return a.chart=nv.models.multiBarChart().staggerLabels(!0).stacked(!0).showYAxis(!1).color(a.settings.colors).controlLabels({grouped:fr.ina.amalia.player.PlayerMessage.PLUGIN_D3JS_CHART_LABELS[0],stacked:fr.ina.amalia.player.PlayerMessage.PLUGIN_D3JS_CHART_LABELS[1]}).margin({left:0,right:0,top:0,bottom:50}),a.chart.xAxis.tickFormat(function(t){return fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(t,a.settings.framerate,a.settings.timeFormat)}),a.updateChartData(),nv.utils.windowResize(a.chart.update),a.chart.multibar.dispatch.on("elementClick",$.proxy(a.onClick,a)),a.chart}})},updateChartData:function(){var t,a=[];for(t in this.dataToDeal){var e=this.mediaPlayer.getBlockMetadata(this.dataToDeal[t]),i=this.dataToDeal[t].toString(),e=null!==e&&e.hasOwnProperty("label")?"-"===e.label?"":e.label:i,i=this.mediaPlayer.getMetadataById(i);this.sortListOfData(i),a.push({key:e,values:$.map(i,function(t){return{x:t.tc,y:t.score}})})}d3.select(this.container.find(".module-chart svg").get(0)).datum(a).transition().duration(500).call(this.chart)},sortListOfData:function(t){t.sort(function(t,a){return t=parseInt(t.tc),(a=parseInt(a.tc))<t?1:t<a?-1:0})},getFocusTcin:function(){var t=this.tcout-this.tcin,t=parseFloat(t*this.container.find(".focus-container ."+this.Class.COMPONENT_NAME).first().position().left/this.container.find(".focus-container").first().width());return Math.max(this.tcin,this.tcin+t)},getFocusTcout:function(){var t=this.getFocusTcin(),a=this.tcout-this.tcin,a=parseFloat(a*this.container.find(".focus-container ."+this.Class.COMPONENT_NAME).first().width()/this.container.find(".focus-container").first().width());return Math.min(this.tcout,t+a)},selectedZoneChange:function(){var t=this.getFocusTcin(),a=this.getFocusTcout();this.mediaPlayer.getContainer().trigger(fr.ina.amalia.player.PlayerEventType.ZOOM_RANGE_CHANGE,{focusTcin:t,focusTcout:a}),null!==this.logger&&this.logger.trace(this.Class.fullName,"selectedZoneChange trigger event :  focusTcin:"+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(t,this.settings.framerate,this.settings.timeFormat)+" focusTcout:"+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(a,this.settings.framerate,this.settings.timeFormat))},updateTimelinePos:function(t){var a=parseFloat(t),t=this.tcout-this.tcin;this.container.find(".timeline-cursor").css("left",100*(a-this.tcin)/t+"%")},onPluginReady:function(){null!==this.logger&&this.logger.trace(this.Class.fullName,"onPluginReady")},onBeginDataChange:function(){this.loadDataStarted=!0,this.dataToDeal=[],null!==this.logger&&this.logger.trace(this.Class.fullName,"onBeginDataChange")},onDataChange:function(t,a){var e;!0===this.loadDataStarted?(e=this.mediaPlayer.getBlockMetadata(a.id),this.isManagedMetadataType(e.type)&&$.inArray(a.id,this.dataToDeal)<0&&this.dataToDeal.push(a.id)):this.updateChartData()},onEndDataChange:function(){this.loadDataStarted=!1,this.initializeOnLoadStart()},onClick:function(t){this.mediaPlayer.setCurrentTime(t.data.x)},onSelectedMetadataChange:function(t,a){this._super(t,a)},onResizeStop:function(){this.selectedZoneChange(),null!==this.logger&&this.logger.trace(this.Class.fullName,"onResizeStop")},onDragStop:function(){this.selectedZoneChange(),null!==this.logger&&this.logger.trace(this.Class.fullName,"onDragStop")},onTimeupdate:function(t,a){this.updateTimelinePos(parseFloat(a.currentTime))}});