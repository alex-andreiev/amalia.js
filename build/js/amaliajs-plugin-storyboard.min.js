/*!Amalia.js ========== V1.3.4, Â© INA 2021 */
/**
 * Copyright (c) 2015 Institut National de l'Audiovisuel, INA
 * This file is part of amalia.js

 * amalia.js is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

 * Redistributions of source code, javascript and css minified versions
 * must retain the above copyright notice, this list of conditions and the following disclaimer.

 * Neither the name of the copyright holder nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.

 * You should have received a copy of the GNU General Public License
 * along with amalia.js. If not, see <http://www.gnu.org/licenses/>

 *
 * amalia.js is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 */


$.Class("fr.ina.amalia.player.BaseFramePositionCalculator",{getFrameByTc:function(t,i,e,a,s,r){i=Math.round(Math.max(1,Math.round(t*a*e/i)/e));return{x:-Math.min(r*(Math.round(t)%e),r*(e-1)),y:-i*s+s}}},{}),fr.ina.amalia.player.plugins.PluginBase.extend("fr.ina.amalia.player.plugins.StoryboardPlugin",{classCss:"ajs-plugin plugin-storyboard",eventTypes:{}},{thumbnailOverlayCanvas:null,storyboardImageObj:null,container:null,positionCalculator:null,initialize:function(){if(this._super(),this.thumbnailOverlayCanvas=null,this.settings=$.extend({topOffset:80,framePositionCalculator:"fr.ina.amalia.player.BaseFramePositionCalculator",storyboardSourceFile:"",framePreviewWidth:160,framePreviewHeight:90,storyboardRow:36,storyboardCol:10,fadeInDuration:300,fadeOutDuration:600,fadeInEffect:"swing",fadeOutEffect:"easeInExpo",filmstrip:!0,thumbScale:1.5},this.settings.parameters||{}),""!==this.settings.storyboardSourceFile){this.container=$("<div>",{class:this.Class.classCss});try{this.positionCalculator=eval(this.settings.framePositionCalculator+".getFrameByTc")}catch(e){this.positionCalculator=fr.ina.amalia.player.BaseFramePositionCalculator.getFrameByTc,null!==this.logger&&this.logger.warn("Set Default position calculator")}this.storyboardImageObj=new Image,this.storyboardImageObj.src=this.settings.storyboardSourceFile,this.pluginContainer.append(this.container),this.createStoryboardElement(),this.defineListeners()}},defineListeners:function(){var t=this.mediaPlayer.getContainer();t.one(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,{self:this},this.onPluginReady),t.on(fr.ina.amalia.player.PlayerEventType.START_SEEKING,{self:this},this.onStartSeeking),t.on(fr.ina.amalia.player.PlayerEventType.SEEKING,{self:this},this.onSeeking),t.on(fr.ina.amalia.player.PlayerEventType.STOP_SEEKING,{self:this},this.onStopSeeking),$(window).on("debouncedresize",{self:this},this.onWindowResize),null!==this.logger&&this.logger.trace(this.Class.fullName,"definePlayerListeners")},initializeOnLoadStart:function(){this.updateFramePreview(0)},createStoryboardElement:function(){var t=$("<div>",{class:"preview-storyboard"}),i=$("<div>",{class:"thumbnail"});i.css({bottom:this.settings.topOffset,height:this.settings.framePreviewHeight,width:this.settings.framePreviewWidth,"margin-left":-this.settings.framePreviewWidth/2,"background-image":"url("+this.settings.storyboardSourceFile+")"}),!0===this.settings.filmstrip&&((e=$("<div>",{class:"filmstrip"})).css({bottom:this.settings.topOffset,height:this.settings.framePreviewHeight}),this.container.append(e));var e=$("<canvas>",{class:"thumbnail-overlay"});e.attr("width",this.settings.framePreviewWidth),e.attr("height",this.settings.framePreviewHeight),this.thumbnailOverlayCanvas=e.get(0).getContext("2d"),t.append(e),this.container.append(i),this.container.append(t),this.updateFramePreview(0)},updateFramePreview:function(t){var i=this.getVideoSize(),e=i.w,a=i.h,s=(this.container.width()-e)/2,i=(this.container.height()-a-this.settings.topOffset)/2;this.container.find(".preview-storyboard").css({width:e+"px",height:a+"px",top:i+"px",left:s+"px"});s=this.mediaPlayer.getDuration();null!==this.positionCalculator&&void 0!==this.positionCalculator&&(s=this.positionCalculator(10*t*s/1e3,s,this.settings.storyboardCol,this.settings.storyboardRow,this.settings.framePreviewHeight,this.settings.framePreviewWidth),this.container.find(".thumbnail").css({"background-position":Math.round(s.x)+"px "+Math.round(s.y)+"px"}),this.thumbnailOverlayCanvas.drawImage(this.storyboardImageObj,s.x,s.y,this.settings.framePreviewWidth*this.settings.storyboardCol,this.settings.framePreviewHeight*this.settings.storyboardRow),!0===this.settings.filmstrip&&this.updateFilmstrip(10*t))},updateFilmstrip:function(t){var i=Math.ceil(this.container.width()/this.settings.framePreviewWidth),e=this.mediaPlayer.getDuration(),a=Math.max(0,t-i),s=Math.min(1e3,t+i);this.container.find(".filmstrip").empty();for(var r=this.container.width()/2-this.settings.framePreviewWidth/2,n=t;a<n;n--){var o=this.positionCalculator(n*e/1e3,e,this.settings.storyboardCol,this.settings.storyboardRow,this.settings.framePreviewHeight,this.settings.framePreviewWidth),h=$("<div>",{class:"storyboard-thumbnail left"});h.css({"background-position":o.x+"px "+o.y+"px",left:r+"px",height:this.settings.framePreviewHeight,width:this.settings.framePreviewWidth,"background-image":"url("+this.settings.storyboardSourceFile+")"}),this.container.find(".filmstrip").append(h),r-=this.settings.framePreviewWidth}for(var l=this.container.width()/2-this.settings.framePreviewWidth/2,d=t;d<s;d++){var g=this.positionCalculator(d*e/1e3,e,this.settings.storyboardCol,this.settings.storyboardRow,this.settings.framePreviewHeight,this.settings.framePreviewWidth),f=$("<div>",{class:"storyboard-thumbnail right"});f.css({"background-position":g.x+"px "+g.y+"px",left:l+"px",height:this.settings.framePreviewHeight,width:this.settings.framePreviewWidth,"background-image":"url("+this.settings.storyboardSourceFile+")"}),this.container.find(".filmstrip").append(f),l+=this.settings.framePreviewWidth}},getVideoSize:function(){var t=this.mediaPlayer.getMediaPlayer(),i=t.get(0).videoHeight,e=t.get(0).videoWidth;0===i&&(i=t.height()),0===e&&(e=t.width());var a=t.width()/e,t=t.height()/i,t=Math.min(a,t);return{w:t*e,h:t*i}},onPluginReady:function(t){t.data.self.initializeOnLoadStart()},onWindowResize:function(t){t.data.self.updateFramePreview()},onStartSeeking:function(t){t.data.self.container.fadeIn({duration:t.data.self.settings.fadeInDuration,easing:t.data.self.settings.fadeInEffect})},onSeeking:function(t,i){t.data.self.updateFramePreview(i.percentage)},onStopSeeking:function(t){t.data.self.container.fadeOut({duration:t.data.self.settings.fadeOutDuration,easing:t.data.self.settings.fadeOutEffect})}});