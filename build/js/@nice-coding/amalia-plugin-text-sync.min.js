/*!Amalia.js ========== V1.3.2, Â© INA 2021 */
/**
 * Copyright (c) 2015 Institut National de l'Audiovisuel, INA
 * This file is part of amalia.js

 * amalia.js is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

 * Redistributions of source code, javascript and css minified versions
 * must retain the above copyright notice, this list of conditions and the following disclaimer.

 * Neither the name of the copyright holder nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.

 * You should have received a copy of the GNU General Public License
 * along with amalia.js. If not, see <http://www.gnu.org/licenses/>

 *
 * amalia.js is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 */


$.Class("fr.ina.amalia.player.plugins.textSyncPlugin.Component",{ComponentClassCss:"line-component",eventTypes:{CLICK:"fr.ina.amalia.player.plugins.textSyncPlugin.Component.event.click"}},{settings:{},logger:null,mainContainer:null,tooltipConfiguration:{position:{my:"left+10 center",at:"right center",delay:3e3,using:function(t,a){$(this).css(t),$("<div>").addClass(a.vertical).addClass(a.horizontal).appendTo(this)}}},init:function(t){if(this.settings=$.extend({debug:!1,framerate:"25",container:""},t||{}),void 0!==fr.ina.amalia.player.log&&void 0!==fr.ina.amalia.player.log.LogHandler&&(this.logger=new fr.ina.amalia.player.log.LogHandler({enabled:this.settings.debug})),this.mainContainer=this.settings.container,0===this.mainContainer.length||"object"!=typeof this.mainContainer)throw new Error("Your container is empty.");this.initialize()},initialize:function(){null!==this.logger&&this.logger.trace(this.Class.fullName,"initialize"),this.mainContainer.addClass(this.Class.ComponentClassCss)},createLine:function(t,a,e,i,n,s){var l=$("<li>",{class:"line media","data-tcin":t,"data-tcout":a}),o=$("<div>",{class:"info pull-left"});n=null!=n?'background-image:url("'+n+'");':"";var r=$("<div>",{class:"thumb","data-tc":t,style:n});o.append(r),r.on("click",{self:this},this.onClickAtTc);n=$("<time>",{class:"tcin badge",title:"Tc in","data-tc":t,text:fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(t,this.settings.framerate,"s")}).tooltip(this.tooltipConfiguration).on("click",{self:this},this.onClickAtTc),r=$("<time>",{class:"tcout badge",title:"Tc out","data-tc":a,text:fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(a,this.settings.framerate,"s")}).tooltip(this.tooltipConfiguration).on("click",{self:this},this.onClickAtTc),t=$("<div>",{class:"ajs-progress"}).hide(),a=$("<div>",{class:"ajs-progress-bar",style:"width:0%;"});t.append(a),o.append(n),o.append(r);r=$("<div>",{class:"content"});null!==e&&(e=$("<label>",{class:"heading",text:e}),r.append(e)),this.textContainer=$("<p>",{class:"text"}),"string"==typeof i?this.textContainer.html(i):this.textContainer.append(i),r.append(this.textContainer),r.append(t),l.append(o),l.append(r),l.data("metadata",s),this.mainContainer.append(l)},addText:function(t){null!==this.textContainer&&(this.textContainer.append(t),this.textContainer.find(".word").on("click",{self:this},this.onClickAtTc))},onClickAtTc:function(t){var a=$(t.currentTarget),a=parseFloat(a.attr("data-tc"));t.data.self.mainContainer.trigger(t.data.self.Class.eventTypes.CLICK,{tc:a}),null!==t.data.self.logger&&t.data.self.logger.trace(t.data.self.Class.fullName,"onClickAtCuepoint tc:"+a)}}),fr.ina.amalia.player.plugins.captions.CaptionsBase.extend("fr.ina.amalia.player.plugins.TextSyncPlugin",{classCss:"ajs-plugin plugin-text-sync",style:""},{withMainLevel:!1,karaoke:!1,loadDataStarted:!1,selectedMetadataId:"",initialize:function(){this.container=$("<ul>",{class:"ajs-media-list"}),this.settings=$.extend({debug:this.settings.debug,framerate:"25",internalPlugin:!1,metadataId:"",level:2,title:"",description:"",displayLevel:"",autoScroll:!1,karaokeOffsetTime:1},this.settings.parameters||{}),this.settings.displayLevel=""===this.settings.displayLevel?this.settings.level:this.settings.displayLevel,this.withMainLevel=this.settings.displayLevel!==this.settings.level,this.karaoke=this.withMainLevel,""!==this.settings.title&&this.createTitleBlock(this.settings.title,this.settings.description),this.container.on(fr.ina.amalia.player.plugins.textSyncPlugin.Component.eventTypes.CLICK,{self:this},this.onClickTc),this.pluginContainer.append(this.container),this.defineEventListeners()},defineEventListeners:function(){var t=this.mediaPlayer.getContainer();t.on(fr.ina.amalia.player.PlayerEventType.BEGIN_DATA_CHANGE,{self:this},this.onBeginDataChange),t.on(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{self:this},this.onDataChange),t.on(fr.ina.amalia.player.PlayerEventType.END_DATA_CHANGE,{self:this},this.onEndDataChange),t.on(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,{self:this},this.onTimeupdate),!0===this.settings.autoScroll&&t.on(fr.ina.amalia.player.PlayerEventType.SEEK,{self:this},this.onSeek),t.on(fr.ina.amalia.player.PlayerEventType.SELECTED_METADATA_CHANGE,{self:this},this.onSelectedMetadataChange)},updateListOfDisplayItems:function(t){var a,e=null;this.container.empty();for(var i=0;i<this.listOfData.length;i++)(a=this.listOfData[i]).level===t?null!==(e=this.createComponent(this.container))?"function"==typeof e.createLine&&e.createLine(a.tcin,a.tcout,a.label,!0===this.withMainLevel?"":a.text,a.thumb,a):null!==this.logger&&this.logger.warn("Error initializing the component."):a.level>t&&null!==e&&e.addText(this.createWord(a));this.container.height(parseInt(this.pluginContainer.height()-parseInt(this.pluginContainer.find(".header").first().height())-20)+"px")},createWord:function(t){return $("<span>",{class:"word",text:t.text,"data-tc":t.tcin,"data-tcin":t.tcin,"data-tcout":t.tcout}).data("metadata",t)},createComponent:function(t,a){var e=null,a=$.extend({debug:this.settings.debug,container:t},a||{});try{e=new fr.ina.amalia.player.plugins.textSyncPlugin.Component(a)}catch(t){null!==this.logger&&this.logger.warn(t)}return e},updatePos:function(n){var e,t,a;n=parseFloat(n),this.container.find(".line").removeClass("on"),this.container.find(".line").filter(function(t,a){return n>=Math.round(parseFloat($(a).attr("data-tcin")))&&n<Math.round(parseFloat($(a).attr("data-tcout")))}).addClass("on").each(function(t,a){a=$(a);var e=Math.round(parseInt($(a).attr("data-tcin"))),i=Math.round(parseInt($(a).attr("data-tcout"))),e=100*(Math.round(n)-e)/(i-e);a.find(".ajs-progress").show(),a.find(".ajs-progress-bar").css("width",Math.round(e)+"%")}),!0===this.karaoke&&(this.container.find(".word").removeClass("on"),(e=this).container.find(".word").filter(function(t,a){return n>=parseFloat($(a).attr("data-tcin"))&&n<parseFloat($(a).attr("data-tcout"))+e.settings.karaokeOffsetTime}).addClass("on")),!0===this.settings.autoScroll&&(t=this.container.find("li.line").eq(0).position(),a=this.container.find("li.line.on").position(),t&&a&&this.container.stop().animate({scrollTop:a.top-t.top}))},createTitleBlock:function(t,a){var e=$("<div>",{class:"header"}),i=$("<div>",{class:"resume"}),t=$("<h3>",{class:"heading",text:t});i.append(t);a=$("<p>",{text:a});i.append(a),e.append(i),this.pluginContainer.append(e)},updateBlockData:function(){""!==this.settings.metadataId?(this.updateMetadata(this.settings.metadataId,this.settings.level,0,this.mediaPlayer.getDuration(),!0),this.updateListOfDisplayItems(this.settings.displayLevel)):""!==this.selectedMetadataId&&(this.updateMetadata(this.selectedMetadataId,this.settings.level,0,this.mediaPlayer.getDuration(),!0),this.updateListOfDisplayItems(this.settings.displayLevel))},onClickTc:function(t,a){!0===a.hasOwnProperty("tc")&&!0!==a.tc&&t.data.self.mediaPlayer.setCurrentTime(parseFloat(a.tc))},onSeek:function(t,a){var e=parseFloat(a.currentTime),i=t.data.self.container.find("li.line").eq(0).position(),a=t.data.self.container.find("li.line").filter(function(t,a){return e>=Math.round(parseFloat($(a).attr("data-tcin")))&&e<Math.round(parseFloat($(a).attr("data-tcout")))}).first().position();a&&i&&t.data.self.container.stop().animate({scrollTop:a.top-i.top},1500,"easeInOutExpo")},onSelectedMetadataChange:function(t,a){""===t.data.self.settings.metadataId&&null!==a.metadataId&&(t.data.self.selectedMetadataId=a.metadataId.toString(),t.data.self.updateBlockData()),null!==t.data.self.logger&&t.data.self.logger.trace(t.data.self.Class.fullName,"onSelectedMetadataChange id:"+a.metadataId)},onBeginDataChange:function(t){t.data.self.loadDataStarted=!0,null!==t.data.self.logger&&t.data.self.logger.trace(t.data.self.Class.fullName,"onBeginDataChange")},onDataChange:function(t){!1===t.data.self.loadDataStarted&&t.data.self.updateBlockData()},onEndDataChange:function(t){t.data.self.loadDataStarted=!1,t.data.self.updateBlockData(),null!==t.data.self.logger&&t.data.self.logger.trace(t.data.self.Class.fullName,"EndDataChange")}});